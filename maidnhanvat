/****************************************************
 * T√äN D·ª∞ √ÅN: REMOTE SMART ESP32-S3 (v12.2 - DUAL MODE ·ªîN ƒê·ªäNH)
 * T√çNH NƒÇNG:
 * - PHI√äN B·∫¢N v12.2:
 * - T√çNH NƒÇNG: Ch·∫°y DUAL MODE (AP + STA) c√πng l√∫c.
 * - S·ª¨A L·ªñI: AP "Remote Smart" (192.168.89.1) lu√¥n lu√¥n b·∫≠t, kh√¥ng bao gi·ªù "t√™ li·ªát".
 * - T·ªêI ∆ØU: X√≥a b·ªè mDNS, ch·ªâ d√πng IP.
 * - GI·ªÆ NGUY√äN: Ki·∫øn tr√∫c L√µi 0 (Logic) / L√µi 1 (M·∫°ng) v√† Ch√¢n An To√†n (1, 13, 14).
 *
 * KI·∫æN TR√öC L√ïI:
 * - L√µi 1 (Core 1): Ch·ªâ ch·∫°y Web Server + DNS (Si√™u m∆∞·ª£t).
 * - L√µi 0 (Core 0): Ch·∫°y Task logic (AutoControl + 3 N√∫t b·∫•m).
 ****************************************************/

#include <WiFi.h>
#include <WebServer.h> 
#include <DNSServer.h>
#include <HTTPClient.h>
#include <Update.h>
#include <Preferences.h>
#include <WiFiClientSecure.h>
// #include <ESPmDNS.h> // <<< ƒê√É X√ìA mDNS

Preferences prefs;

// === BI·∫æN QU·∫¢N L√ù CHO L√ïI 0 ===
TaskHandle_t LogicTaskHandle; 
// =============================

// ‚öôÔ∏è WiFi
const char* ap_ssid = "Remote Smart";
const char* ap_pass = "12345678";
String saved_ssid = ""; 
String saved_pass = ""; 

// ‚öôÔ∏è GPIO
#define PIN_1 4
#define PIN_2 5
#define PIN_3 7
#define PIN_4 16
// === [v12.1] GI·ªÆ NGUY√äN CH√ÇN AN TO√ÄN ===
#define PIN_STOP 13   
#define PIN_RESET 14  
#define PIN_OTA 1     
// ===================================

// ‚öôÔ∏è Bi·∫øn tr·∫°ng th√°i
bool state1, state2, state3, state4;
bool stopAll = false;

// ‚öôÔ∏è Bi·∫øn Preferences
const char* PREF_NAMESPACE = "smart_config";
const char* KEY_STOP_ALL = "stop_state";
const char* KEY_WIFI_SSID = "wifi_ssid";
const char* KEY_WIFI_PASS = "wifi_pass";

// === BI·∫æN H·∫∏N GI·ªú (H:M:S) ===
long p1_s1_start_s, p1_s1_end_s;
long p1_s2_start_s, p1_s2_end_s;
long p1_s3_start_s, p1_s3_end_s;
long p2_s1_start_s, p2_s1_end_s;
long p2_s2_start_s, p2_s2_end_s;
long p2_s3_start_s, p2_s3_end_s;
long p3_s1_start_s, p3_s1_end_s;
long p3_s2_start_s, p3_s2_end_s;
long p3_s3_start_s, p3_s3_end_s;
// ============================================

// ‚öôÔ∏è Web & DNS
WebServer server(80); 
DNSServer dns;

// ‚öôÔ∏è Link OTA
const char* firmware_url = "https://github.com/chuyengamy28-tech/firmware/raw/main/update.bin";

// ====================== STATE PERSISTENCE ======================
void saveState() {
    prefs.begin(PREF_NAMESPACE, false);
    prefs.putBool(KEY_STOP_ALL, stopAll);
    prefs.end();
    Serial.printf("[PREF] ƒê√£ l∆∞u stopAll = %s\n", stopAll ? "TRUE" : "FALSE");
}

void loadState() {
    prefs.begin(PREF_NAMESPACE, true);
    stopAll = prefs.getBool(KEY_STOP_ALL, false);
    prefs.end();
    Serial.printf("[PREF] ƒê√£ t·∫£i stopAll = %s\n", stopAll ? "TRUE" : "FALSE");
}

// === H√ÄM T·∫¢I L·ªäCH H·∫∏N GI·ªú ===
void loadSchedules() {
    prefs.begin(PREF_NAMESPACE, true); 
    
    p1_s1_start_s = prefs.getLong("p1s1_on", 0); p1_s1_end_s = prefs.getLong("p1s1_off", 0);
    p1_s2_start_s = prefs.getLong("p1s2_on", 0); p1_s2_end_s = prefs.getLong("p1s2_off", 0);
    p1_s3_start_s = prefs.getLong("p1s3_on", 0); p1_s3_end_s = prefs.getLong("p1s3_off", 0);
    p2_s1_start_s = prefs.getLong("p2s1_on", 0); p2_s1_end_s = prefs.getLong("p2s1_off", 0);
    p2_s2_start_s = prefs.getLong("p2s2_on", 0); p2_s2_end_s = prefs.getLong("p2s2_off", 0);
    p2_s3_start_s = prefs.getLong("p2s3_on", 0); p2_s3_end_s = prefs.getLong("p2s3_off", 0);
    p3_s1_start_s = prefs.getLong("p3s1_on", 0); p3_s1_end_s = prefs.getLong("p3s1_off", 0);
    p3_s2_start_s = prefs.getLong("p3s2_on", 0); p3_s2_end_s = prefs.getLong("p3s2_off", 0);
    p3_s3_start_s = prefs.getLong("p3s3_on", 0); p3_s3_end_s = prefs.getLong("p3s3_off", 0);

    prefs.end();
    Serial.println("[SCHED] ƒê√£ t·∫£i l·ªãch h·∫πn gi·ªù H:M:S t·ª´ Preferences.");
}

// ====================== C√ÅC TRANG WEB (Kh√¥ng ƒë·ªïi) ======================
// === TRANG WEB C√ÄI ƒê·∫∂T H·∫∏N GI·ªú ===
void handleSchedulePage() {
    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>C√†i ƒë·∫∑t H·∫πn gi·ªù</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;margin-top:0;} a{text-decoration:none;}";
    html += "form{max-width:500px;margin:0 auto 15px auto;padding:15px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}";
    html += ".timegrid{display:grid;grid-template-columns:30px 30px 30px;gap:5px;justify-content:center;}";
    html += ".timegrid input{width:100%;padding:8px 0;text-align:center;border:1px solid #ccc;border-radius:5px;}";
    html += ".schedgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center;margin-top:10px;}";
    html += ".schedgrid label{font-weight:600;font-size:0.9em;margin:0;}";
    html += ".pin_section h4{color:#1976D2;margin:15px 0 10px 0;border-bottom:1px solid #eee;padding-bottom:5px;}";
    html += ".sched_item h5{margin:10px 0 5px 0;font-size:0.95em;color:#555;}";
    html += "button,.btn{width:auto;min-width:120px;padding:0 15px;height:45px;font-size:16px;font-weight:600;margin:5px;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += "button[type='submit']{background-color:#4CAF50;width:100%;margin-top:15px;}"; 
    html += ".home{background-color:#555;display:inline-block;line-height:45px;}"; 
    html += ".note{font-size:0.9em;color:#777;margin-top:15px;}";
    html += "</style></head><body>";
    html += "<h3>C√ÄI ƒê·∫∂T H·∫∏N GI·ªú (CHU K·ª≤ 24 GI·ªú)</h3>"; 
    html += "<p class='note'>Nh·∫≠p Gi·ªù(0-23), Ph√∫t(0-59), Gi√¢y(0-59).<br>ƒê√¢y l√† th·ªùi gian T√çNH T·ª™ L√öC C·∫ÆM ƒêI·ªÜN, l·∫∑p l·∫°i m·ªói 24 gi·ªù.</p>";

    html += "<form action='/save_hengio' method='POST'>";
    auto getHMS = [](long totalSeconds) {
        int h = totalSeconds / 3600; totalSeconds %= 3600; int m = totalSeconds / 60; int s = totalSeconds % 60;
        return String(h) + "," + String(m) + "," + String(s);
    };
    auto addScheduleInputs = [&](String prefix, long start_s, long end_s) {
        String startHMS = getHMS(start_s); String endHMS = getHMS(end_s);
        int h_on, m_on, s_on, h_off, m_off, s_off;
        sscanf(startHMS.c_str(), "%d,%d,%d", &h_on, &m_on, &s_on);
        sscanf(endHMS.c_str(), "%d,%d,%d", &h_off, &m_off, &s_off);
        html += "<div class='schedgrid'>";
        html += "<div><label>B·∫¨T (H:M:S)</label><div class='timegrid'>";
        html += "<input type='number' min='0' max='23' name='" + prefix + "_h_on' value='" + h_on + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_m_on' value='" + m_on + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_s_on' value='" + s_on + "'>";
        html += "</div></div>";
        html += "<div><label>T·∫ÆT (H:M:S)</label><div class='timegrid'>";
        html += "<input type='number' min='0' max='23' name='" + prefix + "_h_off' value='" + h_off + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_m_off' value='" + m_off + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_s_off' value='" + s_off + "'>";
        html += "</div></div>";
        html += "</div>";
    };
    html += "<div class='pin_section'>";
    html += "<h4>·ªî c·∫Øm 1 (t√™n m√°y)</h4>";
    html += "<h5>L·ªãch 1</h5>"; addScheduleInputs("p1s1", p1_s1_start_s, p1_s1_end_s);
    html += "<h5>L·ªãch 2</h5>"; addScheduleInputs("p1s2", p1_s2_start_s, p1_s2_end_s);
    html += "<h5>L·ªãch 3</h5>"; addScheduleInputs("p1s3", p1_s3_start_s, p1_s3_end_s);
    html += "</div>";
    html += "<div class='pin_section'>";
    html += "<h4>·ªî c·∫Øm 2 (t√™n m√°y)</h4>";
    html += "<h5>L·ªãch 1</h5>"; addScheduleInputs("p2s1", p2_s1_start_s, p2_s1_end_s);
    html += "<h5>L·ªãch 2</h5>"; addScheduleInputs("p2s2", p2_s2_start_s, p2_s2_end_s);
    html += "<h5>L·ªãch 3</h5>"; addScheduleInputs("p2s3", p2_s3_start_s, p2_s3_end_s);
    html += "</div>";
    html += "<div class='pin_section'>";
    html += "<h4>·ªî c·∫Øm 3 (t√™n m√°y)</h4>";
    html += "<h5>L·ªãch 1</h5>"; addScheduleInputs("p3s1", p3_s1_start_s, p3_s1_end_s);
    html += "<h5>L·ªãch 2</h5>"; addScheduleInputs("p3s2", p3_s2_start_s, p3_s2_end_s);
    html += "<h5>L·ªãch 3</h5>"; addScheduleInputs("p3s3", p3_s3_start_s, p3_s3_end_s);
    html += "</div>";
    html += "<p class='note' style='color:red;font-weight:bold;'>Ch√¢n 16 (PIN_4) ch·ªâ ƒëi·ªÅu khi·ªÉn b·∫±ng tay.</p>";
    html += "<button type='submit'>L∆∞u C√†i ƒê·∫∑t</button>";
    html += "</form>";
    html += "<a href='/' class='btn home'>Quay v·ªÅ trang ch·ªß</a>";
    html += "</body></html>";
    server.send(200, "text/html", html);
}
// === H√ÄM X·ª¨ L√ù L∆ØU H·∫∏N GI·ªú ===
void handleSaveSchedule() {
    Serial.println("[WEB] ƒêang nh·∫≠n l·ªãch h·∫πn gi·ªù H:M:S m·ªõi...");
    auto getSecondsFromForm = [&](String prefix, String type) {
        long h = server.arg(prefix + "_h_" + type).toInt();
        long m = server.arg(prefix + "_m_" + type).toInt();
        long s = server.arg(prefix + "_s_" + type).toInt();
        return (h * 3600) + (m * 60) + s;
    };
    p1_s1_start_s = getSecondsFromForm("p1s1", "on"); p1_s1_end_s = getSecondsFromForm("p1s1", "off");
    p1_s2_start_s = getSecondsFromForm("p1s2", "on"); p1_s2_end_s = getSecondsFromForm("p1s2", "off");
    p1_s3_start_s = getSecondsFromForm("p1s3", "on"); p1_s3_end_s = getSecondsFromForm("p1s3", "off");
    p2_s1_start_s = getSecondsFromForm("p2s1", "on"); p2_s1_end_s = getSecondsFromForm("p2s1", "off");
    p2_s2_start_s = getSecondsFromForm("p2s2", "on"); p2_s2_end_s = getSecondsFromForm("p2s2", "off");
    p2_s3_start_s = getSecondsFromForm("p2s3", "on"); p2_s3_end_s = getSecondsFromForm("p2s3", "off");
    p3_s1_start_s = getSecondsFromForm("p3s1", "on"); p3_s1_end_s = getSecondsFromForm("p3s1", "off");
    p3_s2_start_s = getSecondsFromForm("p3s2", "on"); p3_s2_end_s = getSecondsFromForm("p3s2", "off");
    p3_s3_start_s = getSecondsFromForm("p3s3", "on"); p3_s3_end_s = getSecondsFromForm("p3s3", "off");

    prefs.begin(PREF_NAMESPACE, false); 
    prefs.putLong("p1s1_on", p1_s1_start_s); prefs.putLong("p1s1_off", p1_s1_end_s);
    prefs.putLong("p1s2_on", p1_s2_start_s); prefs.putLong("p1s2_off", p1_s2_end_s);
    prefs.putLong("p1s3_on", p1_s3_start_s); prefs.putLong("p1s3_off", p1_s3_end_s);
    prefs.putLong("p2s1_on", p2_s1_start_s); prefs.putLong("p2s1_off", p2_s1_end_s);
    prefs.putLong("p2s2_on", p2_s2_start_s); prefs.putLong("p2s2_off", p2_s2_end_s);
    prefs.putLong("p2s3_on", p2_s3_start_s); prefs.putLong("p2s3_off", p2_s3_end_s);
    prefs.putLong("p3s1_on", p3_s1_start_s); prefs.putLong("p3s1_off", p3_s1_end_s);
    prefs.putLong("p3s2_on", p3_s2_start_s); prefs.putLong("p3s2_off", p3_s2_end_s);
    prefs.putLong("p3s3_on", p3_s3_start_s); prefs.putLong("p3s3_off", p3_s3_end_s);
    prefs.end();
    Serial.println("[SCHED] ƒê√£ l∆∞u 18 m·ªëc H:M:S v√†o Preferences.");
    String html = "<html><head><meta charset='utf-8'><title>ƒêang l∆∞u</title>";
    html += "<meta http-equiv='refresh' content='2;url=/'></head>"; 
    html += "<body><p style='font-family:sans-serif;text-align:center;margin-top:30px;font-size:1.2em;'>";
    html += "‚úÖ ƒê√£ l∆∞u h·∫πn gi·ªù H:M:S!<br>ƒêang quay v·ªÅ trang ch·ªß...</p></body></html>";
    server.send(200, "text/html", html);
}
// --- C√°c trang WiFi ---
void handleWifiSettings() {
    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>C√†i ƒë·∫∑t WiFi</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;margin-top:0;}";
    html += "a{text-decoration:none;}";
    html += "form{max-width:350px;margin:0 auto;padding:20px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}";
    html += "input[type='text'],input[type='password'],select{width:100%;box-sizing:border-box;padding:12px;margin:10px 0;border:1px solid #ccc;border-radius:8px;font-size:16px;}";
    html += "button,.btn{width:auto;min-width:120px;padding:0 15px;height:45px;font-size:16px;font-weight:600;margin:5px;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += "button[type='submit']{background-color:#2196F3;width:100%;}"; 
    html += ".scan{background-color:#FF9800;}"; 
    html += ".home{background-color:#555;display:inline-block;line-height:45px;margin-top:15px;}";
    html += "</style>";
    html += "</head><body>";
    html += "<form action='/savewifi' method='POST'>";
    html += "<h3>C√ÄI ƒê·∫∂T WIFI</h3>";
    if (WiFi.status() == WL_CONNECTED) {
        html += "<p style='color:green;'>ƒêang k·∫øt n·ªëi: <strong>" + WiFi.SSID() + "</strong></p>";
    } else {
        html += "<p style='color:red;'>Ch∆∞a k·∫øt n·ªëi WiFi</p>";
    }
    html += "<input id='ssid' name='ssid' type='text' placeholder='T√™n WiFi (SSID)' value='" + saved_ssid + "'>";
    html += "<input name='pass' type='password' placeholder='M·∫≠t kh·∫©u WiFi'>";
    html += "<button type='submit'>L∆∞u & Kh·ªüi ƒë·ªông l·∫°i</button>";
    html += "</form>";
    html += "<form action='/wifi_scan_results' method='GET' style='margin-top:15px;padding:15px;'>";
    html += "<h4 style='margin:15px 0 5px 0;'>Kh√¥ng nh·ªõ t√™n?</h4>";
    html += "<button class='scan' type='submit'>Qu√©t WiFi ƒë·ªÉ ch·ªçn</button>";
    html += "</form>";
    html += "<a href='/' class='btn home'>Quay v·ªÅ trang ch·ªß</a>";
    html += "</body></html>";
    server.send(200, "text/html", html);
}
void handleWifiScanResults() {
    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>Qu√©t WiFi</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;margin-top:0;}";
    html += "a{text-decoration:none;}";
    html += "form{max-width:350px;margin:0 auto;padding:20px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}";
    html += "input[type='text'],input[type='password'],select{width:100%;box-sizing:border-box;padding:12px;margin:10px 0;border:1px solid #ccc;border-radius:8px;font-size:16px;}";
    html += "button,.btn{width:auto;min-width:120px;padding:0 15px;height:45px;font-size:16px;font-weight:600;margin:5px;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += ".scan{background-color:#FF9800;}"; 
    html += ".home{background-color:#555;display:inline-block;line-height:45px;margin-top:15px;}";
    html += "h4{margin:15px 0 5px 0;}";
    html += "</style>";
    html += "<script>";
    html += "function sel(v){ var el = document.getElementById('selected_ssid_text'); if(el) el.innerHTML = 'ƒê√£ ch·ªçn: <strong>' + v + '</strong><br>Quay l·∫°i trang tr∆∞·ªõc ƒë·ªÉ L∆∞u.'; }";
    html += "</script>";
    html += "</head><body>";
    html += "<div style='max-width:350px;margin:0 auto;'>";
    html += "<h3>K·∫æT QU·∫¢ QU√âT WIFI</h3>";
    html += "<p>ƒêang qu√©t... vui l√≤ng ch·ªù.</p>";
    html += "<form action='/wifi_scan_results' method='GET' style='padding:15px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);'>";
    html += "<button class='scan' type='submit'>Qu√©t l·∫°i</button>";
    Serial.println("[WIFI] B·∫Øt ƒë·∫ßu qu√©t m·∫°ng...");
    int n = WiFi.scanNetworks();
    Serial.printf("[WIFI] Qu√©t xong, t√¨m th·∫•y %d m·∫°ng.\n", n);
    if (n > 0) {
        html += "<h4>T√¨m th·∫•y " + String(n) + " m·∫°ng:</h4>";
        html += "<select onchange='sel(this.value)'>";
        html += "<option value=''>-- Ch·ªçn m·∫°ng --</option>";
        for (int i = 0; i < n; ++i) {
            html += "<option value='" + WiFi.SSID(i) + "'>" + WiFi.SSID(i) + " (" + WiFi.RSSI(i) + "dBm)</option>";
        }
        html += "</select>";
        html += "<p id='selected_ssid_text' style='margin-top:10px;color:green;'></p>";
    } else {
        html += "<p>Kh√¥ng t√¨m th·∫•y m·∫°ng WiFi n√†o.</p>";
    }
    html += "</form>";
    html += "<a href='/wifi' class='btn home'>Quay l·∫°i C√†i ƒë·∫∑t</a>";
    html += "</div></body></html>";
    server.send(200, "text/html", html);
}
void handleSaveWifi() {
    String ssid = server.arg("ssid");
    String pass = server.arg("pass");
    Serial.println("[WIFI] ƒêang l∆∞u c√†i ƒë·∫∑t WiFi m·ªõi...");
    Serial.println("SSID: " + ssid);
    prefs.begin(PREF_NAMESPACE, false);
    prefs.putString(KEY_WIFI_SSID, ssid);
    prefs.putString(KEY_WIFI_PASS, pass);
    prefs.end();
    saved_ssid = ssid;
    saved_pass = pass;
    String html = "<html><head><meta charset='utf-8'><title>ƒêang l∆∞u</title>";
    html += "<meta http-equiv='refresh' content='5;url=/'></head>"; 
    html += "<body><p>ƒê√£ l∆∞u WiFi! ƒêang kh·ªüi ƒë·ªông l·∫°i...</p></body></html>";
    server.send(200, "text/html", html);
    delay(2000);
    ESP.restart();
}
// --- TRANG CH·ª¶ ---
String htmlPage() {
    unsigned long now_ms = millis();
    unsigned long cycle_ms = now_ms % (24UL * 3600UL * 1000UL); 
    long h = cycle_ms / 3600000; cycle_ms %= 3600000;
    long m = cycle_ms / 60000; cycle_ms %= 60000;
    long s = cycle_ms / 1000;
    char timeStr[50];
    sprintf(timeStr, "%02ld:%02ld:%02ld (Chu k·ª≥ 24 gi·ªù)", h, m, s);

    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>Remote Smart (v12.2)</title>"; // S·ª≠a ti√™u ƒë·ªÅ
    html += "<style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;}";
    html += "a{text-decoration:none;}";
    html += ".container{max-width:800px;margin:0 auto;}";
    html += ".status{margin-bottom:20px;padding:15px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);line-height:1.7;text-align:left;}";
    html += ".status strong{color:#555;}";
    html += ".grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:20px;}";
    html += ".card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;flex-direction:column;justify-content:space-between;}";
    html += ".card h4{margin:0 0 10px 0;color:#333;font-size:1em;}";
    html += "button,.btn{width:100%;height:45px;font-size:16px;font-weight:600;margin:5px 0 0 0;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += ".on{background-color:#4CAF50;}";
    html += ".off{background-color:#f44336;}";
    html += ".control{background-color:#2196F3;}";
    html += ".ota{background-color:#FF9800;}"; 
    html += ".wifi{background-color:#555;}"; 
    html += "</style></head><body>";

    html += "<div class='container'>";
    html += "<h3>H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN (v12.2)</h3>"; // S·ª≠a ti√™u ƒë·ªÅ

    // --- Card Tr·∫°ng th√°i [v12.2] ---
    html += "<div class='status'>";
    // Hi·ªÉn th·ªã IP STA (n·∫øu c√≥)
    if (WiFi.status() == WL_CONNECTED) {
        html += "<strong>WIFI: </strong><span style='color:green;'>" + WiFi.SSID() + " (" + WiFi.localIP().toString() + ")</span><br>";
    }
    // Lu√¥n hi·ªÉn th·ªã IP c·ªßa AP
    html += "<strong>AP: </strong><span style='color:blue;'>" + WiFi.softAPIP().toString() + " (" + ap_ssid + ")</span><br>";

    html += "<strong>TH·ªúI GIAN CH·∫†Y: </strong>" + String(timeStr) + "<br>";
    String status_text = stopAll ? "<span style='color:#f44336;'>ƒêANG D·ª™NG</span>" : "<span style='color:#4CAF50;'>ƒêANG CH·∫†Y</span>";
    html += "<strong>T·ª∞ ƒê·ªòNG: </strong>" + status_text + "</div>";
    // --- K·∫øt th√∫c Card Tr·∫°ng th√°i [v12.2] ---

    // --- L∆∞·ªõi c√°c n√∫t ---
    html += "<div class='grid'>";
    auto addBtnCard = [&](String name, bool state, String url, String cssClass = "") {
        String cls = cssClass.isEmpty() ? (state ? "on" : "off") : cssClass;
        String label = (cssClass == "control" || cssClass == "ota" || cssClass == "wifi") ? name : (state ? "ON" : "OFF");
        html += "<div class='card'>";
        html += "<h4>" + name + "</h4>";
        html += "<button class='" + cls + "' onclick=\"location.href='" + url + "'\">" + label + "</button>";
        html += "</div>";
    };
    addBtnCard("·ªî c·∫Øm 1 (t√™n m√°y)", state1, "/toggle1");
    addBtnCard("·ªî c·∫Øm 2 (t√™n m√°y)", state2, "/toggle2");
    addBtnCard("·ªî c·∫Øm 3 (t√™n m√°y)", state3, "/toggle3");
    addBtnCard("·ªî c·∫Øm 4 (t√™n m√°y)", state4, "/toggle4"); 
    addBtnCard(stopAll ? "B·∫≠t t·ª± ƒë·ªông" : "D·ª´ng t·ª± ƒë·ªông", stopAll, "/toggleStop", "control");
    addBtnCard("Kh·ªüi ƒë·ªông l·∫°i", false, "/resetAuto", "control");
    addBtnCard("C√†i ƒë·∫∑t H·∫πn gi·ªù", false, "/hengio", "ota"); 
    addBtnCard("C√†i ƒë·∫∑t WiFi", false, "/wifi", "wifi"); 
    html += "</div>"; 
    html += "<div class='grid' style='grid-template-columns:1fr;'>";
    addBtnCard("C·∫≠p nh·∫≠t FW", false, "/otaUpdate", "ota");
    html += "</div>";
    html += "</div>"; 
    html += "</body></html>";
    return html;
}
// =============================================================

// ====================== OTA ======================
void performOTA() {
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("‚ùå L·ªñI OTA: Kh√¥ng c√≥ k·∫øt n·ªëi WiFi (STA). Vui l√≤ng k·∫øt n·ªëi WiFi tr∆∞·ªõc.");
        return; 
    }
    WiFiClientSecure client;
    client.setInsecure();
    HTTPClient https;
    Serial.println("üîó K·∫øt n·ªëi ƒë·∫øn GitHub...");
    if (!https.begin(client, firmware_url)) {
        Serial.println("‚ùå Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi HTTPS!");
        return;
    }
    int httpCode = https.GET();
    if (httpCode == HTTP_CODE_FOUND || httpCode == HTTP_CODE_MOVED_PERMANENTLY) {
        String newURL = https.getLocation();
        Serial.println("‚û°Ô∏è Chuy·ªÉn h∆∞·ªõng ƒë·∫øn: " + newURL);
        https.end();
        if (!https.begin(client, newURL)) return;
        httpCode = https.GET();
    }
    if (httpCode == HTTP_CODE_OK) {
        int contentLength = https.getSize();
        WiFiClient *stream = https.getStreamPtr();
        if (contentLength > 0 && Update.begin(contentLength)) {
            Serial.printf("üì¶ Firmware: %d bytes\n", contentLength);
            size_t written = Update.writeStream(*stream);
            Serial.printf("üìù ƒê√£ ghi: %d bytes\n", written);
            if (written == contentLength && Update.end(true)) {
                Serial.println("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng! Kh·ªüi ƒë·ªông l·∫°i...");
                delay(1000);
                ESP.restart();
            }
        } else {
            Serial.println("‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i ho·∫∑c file qu√° l·ªõn!");
        }
    } else {
        Serial.printf("‚ùå L·ªói t·∫£i Firmware, HTTP code: %d\n", httpCode);
    }
    https.end();
}

// === H√ÄM AUTOCONTROL (L√µi 0) ===
void autoControl() {
    if (stopAll) return;
    const unsigned long CYCLE_SECONDS = 24UL * 3600UL; // 86400 gi√¢y
    unsigned long currentTimeInSeconds = (millis() / 1000) % CYCLE_SECONDS;
    auto getTargetState = [&](long startSec, long endSec) {
        if (startSec == endSec) return false; 
        if (startSec < endSec) {
            return (currentTimeInSeconds >= startSec) && (currentTimeInSeconds < endSec);
        } else {
            return (currentTimeInSeconds >= startSec) || (currentTimeInSeconds < endSec);
        }
    };
    bool targetState1 = getTargetState(p1_s1_start_s, p1_s1_end_s) ||
                          getTargetState(p1_s2_start_s, p1_s2_end_s) ||
                          getTargetState(p1_s3_start_s, p1_s3_end_s);
    if (targetState1 != state1) {
        state1 = targetState1;
        digitalWrite(PIN_1, state1);
        Serial.printf("[AUTO] Ch√¢n 4: %s\n", state1 ? "B·∫¨T" : "T·∫ÆT");
    }
    bool targetState2 = getTargetState(p2_s1_start_s, p2_s1_end_s) ||
                          getTargetState(p2_s2_start_s, p2_s2_end_s) ||
                          getTargetState(p2_s3_start_s, p2_s3_end_s);
    if (targetState2 != state2) {
        state2 = targetState2;
        digitalWrite(PIN_2, state2);
        Serial.printf("[AUTO] Ch√¢n 5: %s\n", state2 ? "B·∫¨T" : "T·∫ÆT");
    }
    bool targetState3 = getTargetState(p3_s1_start_s, p3_s1_end_s) ||
                          getTargetState(p3_s2_start_s, p3_s2_end_s) ||
                          getTargetState(p3_s3_start_s, p3_s3_end_s);
    if (targetState3 != state3) {
        state3 = targetState3;
        digitalWrite(PIN_3, state3);
        Serial.printf("[AUTO] Ch√¢n 7: %s\n", state3 ? "B·∫¨T" : "T·∫ÆT");
    }
}


// === [v12.0] T√ÅC V·ª§ L√ïI 0 (CH·∫†Y LOGIC + N√öT B·∫§M) ===
void logicTask(void *pvParameters) {
    Serial.println("[TASK] T√°c v·ª• Logic (L√µi 0) ƒë√£ kh·ªüi ƒë·ªông.");

    unsigned long lastAutoControl = 0;

    // [v12.0] Bi·∫øn ƒë·∫øm ch·ªëng nhi·ªÖu cho n√∫t b·∫•m
    const int BUTTON_HOLD_COUNT = 10; // 10 * 100ms = 1 gi√¢y
    static int stop_counter = 0;
    static int reset_counter = 0;
    static int ota_counter = 0;
    // [v12.1] Bi·∫øn ch·ªëng l·∫∑p n√∫t OTA (cooldown 3 gi√¢y)
    static int ota_cooldown = 0; 

    for (;;) { 
        // 1. Ch·∫°y autoControl 1 gi√¢y 1 l·∫ßn
        if (millis() - lastAutoControl >= 1000) {
            autoControl(); 
            lastAutoControl = millis();
        }

        // 2. [v12.0] X·ª≠ l√Ω 3 n√∫t b·∫•m (ƒë√£ ch·ªëng nhi·ªÖu)
        
        // --- N√∫t STOP (PIN 13) ---
        if (digitalRead(PIN_STOP) == LOW) {
            stop_counter++;
            if (stop_counter == BUTTON_HOLD_COUNT) { // V·ª´a ƒë·∫°t 1 gi√¢y
                Serial.println("[BUTTON] Auto Control D·ª™NG (PIN_13 - ƒë√£ gi·ªØ 1s)");
                if (!stopAll) {
                    stopAll = true;
                    saveState();
                }
            }
        } else {
            stop_counter = 0; // Nh·∫£ n√∫t
        }

        // --- N√∫t RESET (PIN 14) ---
        if (digitalRead(PIN_RESET) == LOW) {
            reset_counter++;
            if (reset_counter == BUTTON_HOLD_COUNT) { // V·ª´a ƒë·∫°t 1 gi√¢y
                Serial.println("[BUTTON] ƒê√£ x√°c nh·∫≠n nh·∫•n RESET (PIN_14 - gi·ªØ > 1s)! Bat Auto va restart...");
                stopAll = false; 
                saveState();     
                ESP.restart(); // An to√†n khi g·ªçi t·ª´ L√µi 0
            }
        } else {
            reset_counter = 0;
        }

        // --- N√∫t OTA (PIN 1) ---
        
        // [v12.1] X·ª≠ l√Ω cooldown
        if (ota_cooldown > 0) {
            ota_cooldown--; // ƒê·∫øm ng∆∞·ª£c
            ota_counter = 0; // Reset b·ªô ƒë·∫øm nh·∫•n
        } 
        // [v12.1] Ch·ªâ x·ª≠ l√Ω nh·∫•n n√∫t khi kh√¥ng cooldown
        else if (digitalRead(PIN_OTA) == LOW) {
            ota_counter++;
            if (ota_counter == BUTTON_HOLD_COUNT) { // V·ª´a ƒë·∫°t 1 gi√¢y
                Serial.println("[BUTTON] ƒê√£ x√°c nh·∫≠n nh·∫•n OTA (PIN_1 - gi·ªØ > 1s).");
                if (WiFi.status() == WL_CONNECTED) {
                    Serial.println("ƒêang ch·∫°y OTA Task (t·ª´ L√µi 0)...");
                    xTaskCreate(
                        [](void* pv){ performOTA(); vTaskDelete(NULL); }, 
                        "OTATask_Button", 8192, NULL, 2, NULL
                    );
                } else {
                    Serial.println("L·ªñI: Kh√¥ng c√≥ WiFi ƒë·ªÉ ch·∫°y OTA!");
                }
                // [v12.1] ƒê·∫∑t cooldown 3 gi√¢y (30 * 100ms)
                ota_cooldown = 30; 
            }
        } else {
            ota_counter = 0; // Nh·∫£ n√∫t
        }
        
        // 3. Ngh·ªâ 100ms
        vTaskDelay(100 / portTICK_PERIOD_MS);
    }
}
// ===================================


// ====================== SETUP (v12.4 - S·ª¨A L·ªñI AP "ƒê∆†") ======================
void setup() {
    Serial.begin(115200);

    // [v12.0] Kh·ªüi ƒë·ªông T√°c v·ª• Logic tr√™n L√ïI 0 tr∆∞·ªõc
    xTaskCreatePinnedToCore(
        logicTask, "LogicTask", 4096, NULL, 1, &LogicTaskHandle, 0
    );

    // [v12.0] To√†n b·ªô code c√≤n l·∫°i (Setup, Loop) s·∫Ω t·ª± ƒë·ªông ch·∫°y tr√™n L√ïI 1

    loadState(); 
    loadSchedules(); 

    prefs.begin(PREF_NAMESPACE, true);
    saved_ssid = prefs.getString(KEY_WIFI_SSID, "");
    saved_pass = prefs.getString(KEY_WIFI_PASS, "");
    prefs.end();

    // C·∫•u h√¨nh OUTPUT (L√µi 1)
    pinMode(PIN_1, OUTPUT); digitalWrite(PIN_1, LOW);
    pinMode(PIN_2, OUTPUT); digitalWrite(PIN_2, LOW);
    pinMode(PIN_3, OUTPUT); digitalWrite(PIN_3, LOW);
    pinMode(PIN_4, OUTPUT); digitalWrite(PIN_4, LOW);

    // C·∫•u h√¨nh INPUT (L√µi 1) - C√°c ch√¢n m·ªõi v12.1
    pinMode(PIN_STOP, INPUT_PULLUP);
    pinMode(PIN_RESET, INPUT_PULLUP);
    pinMode(PIN_OTA, INPUT_PULLUP);

    state1 = state2 = state3 = state4 = LOW;

    // === [v12.4] LOGIC WIFI M·ªöI (AP LU√îN CH·∫†Y + STA C√ì TIMEOUT) ===
    
    Serial.println("üîÑ Kh·ªüi ƒë·ªông ·ªü ch·∫ø ƒë·ªô AP+STA...");
    WiFi.disconnect(true); // D·ªçn d·∫πp
    WiFi.mode(WIFI_AP_STA); 

    // 1. C·∫•u h√¨nh v√† B·∫¨T AP (Lu√¥n lu√¥n ch·∫°y tr∆∞·ªõc)
    Serial.println("[AP] ƒêang c·∫•u h√¨nh IP AP th√†nh 192.168.89.1...");
    IPAddress local_ip(192, 168, 89, 1);
    IPAddress gateway(192, 168, 89, 1);
    IPAddress subnet(255, 255, 255, 0);
    if (!WiFi.softAPConfig(local_ip, gateway, subnet)) {
        Serial.println("‚ùå L·ªói c·∫•u h√¨nh softAP!");
    } 
    
    Serial.println("[AP] B·∫≠t AP 'Remote Smart' tr√™n K√™nh 6...");
    if (!WiFi.softAP(ap_ssid, ap_pass, 6)) { // √âp K√™nh 6
         Serial.println("‚ùå L·ªói kh·ªüi ƒë·ªông softAP!");
    }
    
    delay(100);
    dns.start(53, "*", WiFi.softAPIP());
    Serial.println("‚úÖ AP ƒë√£ kh·ªüi ƒë·ªông: " + String(ap_ssid));
    Serial.print("IP AP: "); Serial.println(WiFi.softAPIP());
    
    // 2. TH·ª¨ K·∫æT N·ªêI STA (v·ªõi 15s Timeout)
    if (saved_ssid.length() > 0) {
        Serial.printf("üì° ƒêang th·ª≠ k·∫øt n·ªëi STA (15s timeout) ƒë·∫øn: %s...\n", saved_ssid.c_str());
        WiFi.begin(saved_ssid.c_str(), saved_pass.c_str());

        unsigned long startTime = millis();
        bool timeout = false;
        
        while (WiFi.status() != WL_CONNECTED) {
            delay(500); // Delay trong setup() l√† an to√†n
            Serial.print(".");
            if (millis() - startTime > 15000) { 
                Serial.println("\n‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi STA (Timeout)!");
                timeout = true;
                break; 
            }
        }

        if (timeout == false) {
            Serial.println("\n‚úÖ WiFi (STA) ƒë√£ k·∫øt n·ªëi!");
            Serial.print("IP: "); Serial.println(WiFi.localIP());
        } else {
             // === [S·ª¨A L·ªñI v12.4] D·ª™NG VI·ªÜC T√ÅI K·∫æT N·ªêI ===
             Serial.println("[FIX] D·ª´ng h·∫≥n vi·ªác th·ª≠ k·∫øt n·ªëi STA (ƒë·ªÉ AP ch·∫°y m∆∞·ª£t).");
             WiFi.disconnect(true); // <- D√≤ng n√†y c·ª±c k·ª≥ quan tr·ªçng
             // (AP v·∫´n ch·∫°y v√¨ ch√∫ng ta v·∫´n ·ªü mode WIFI_AP_STA)
        }

    } else {
        Serial.println("‚ÑπÔ∏è Kh√¥ng c√≥ WiFi STA n√†o ƒë∆∞·ª£c l∆∞u. Ch·ªâ ch·∫°y AP.");
    }
    // =========================================================

    // --- Khai b√°o Web Server Handlers (L√µi 1) ---
    server.on("/", [](){ server.send(200, "text/html", htmlPage()); });
    server.on("/hengio", HTTP_GET, handleSchedulePage);
    server.on("/save_hengio", HTTP_POST, handleSaveSchedule);
    server.on("/toggle1", [](){
        if (stopAll) { state1 = !state1; digitalWrite(PIN_1, state1); }
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/toggle2", [](){
        if (stopAll) { state2 = !state2; digitalWrite(PIN_2, state2); }
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/toggle3", [](){
        if (stopAll) { state3 = !state3; digitalWrite(PIN_3, state3); }
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/toggle4", [](){
        state4 = !state4;
        digitalWrite(PIN_4, state4);
        Serial.printf("[WEB] Ch√¢n 16 (PIN_4) ƒë√£ chuy·ªÉn sang: %s\n", state4 ? "ON" : "OFF");
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/toggleStop", [](){
        stopAll = !stopAll;
        saveState();
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/resetAuto", [](){
        Serial.println("[WEB] Nhan nut KHOI DONG LAI! Bat Auto va restart...");
        stopAll = false; 
        saveState();     
        server.send(200, "text/html", "<p style='font-family:sans-serif;font-size:1.2em;text-align:center;'>Da bat Auto.<br>Dang khoi dong lai...</p>");
        xTaskCreate([](void* pv){ vTaskDelay(1000/portTICK_PERIOD_MS); ESP.restart(); }, "RestartTask", 2048, NULL, 2, NULL);
    });
    server.on("/otaUpdate", [](){ 
        if (WiFi.status() != WL_CONNECTED) {
             server.send(200, "text/html", "<h3>L·ªñI: Ph·∫£i k·∫øt n·ªëi WiFi (STA) tr∆∞·ªõc khi c·∫≠p nh·∫≠t!</h3>");
             return;
        }
        server.send(200, "text/html", "<h3>ƒêang c·∫≠p nh·∫≠t firmware...</h3>"); 
        xTaskCreate([](void* pv){ performOTA(); vTaskDelete(NULL); }, "OTATask", 8192, NULL, 2, NULL);
    });
    server.on("/wifi", HTTP_GET, handleWifiSettings); 
    server.on("/wifi_scan_results", HTTP_GET, handleWifiScanResults); 
    server.on("/savewifi", HTTP_POST, handleSaveWifi); 
    
    // --- Captive Portal (L√µi 1) ---
    server.onNotFound([]() {
        String url = "http://" + WiFi.softAPIP().toString() + "/";
        if (WiFi.status() != WL_CONNECTED && saved_ssid.length() == 0) {
             url = "http://" + WiFi.softAPIP().toString() + "/wifi";
        }
        server.sendHeader("Location", url, true);
        server.send(302, "text/plain", "");
    });

    server.begin();
    Serial.println("‚úÖ ESP32-S3 (v12.4 - ·ªîn ƒë·ªãnh AP) ƒë√£ kh·ªüi ƒë·ªông ho√†n t·∫•t!");
    Serial.println("=====================================================");
    Serial.println("‚û°Ô∏è L√ïI 1 (M·∫†NG) ƒêANG CH·∫†Y. ");
    Serial.println("‚û°Ô∏è L√ïI 0 (LOGIC) ƒêANG CH·∫†Y. ");
    Serial.println("=====================================================");

} // <<< K·∫æT TH√öC SETUP()


/// ====================== LOOP (L√ïI 1 - v12.3 - S·ª¨A L·ªñI AP CH·∫¨M) ======================
void loop() {
    // [v12.3] S·ª¨A L·ªñI: ∆Øu ti√™n Web Server ch·∫°y tr∆∞·ªõc
    server.handleClient(); 

    // Ch·∫°y DNS (Captive Portal) sau
    if (WiFi.getMode() == WIFI_AP || WiFi.getMode() == WIFI_AP_STA) {
        dns.processNextRequest(); 
    }
    
    // (Kh√¥ng l√†m g√¨ kh√°c ·ªü ƒë√¢y ƒë·ªÉ L√µi 1 ƒë∆∞·ª£c r·∫£nh)
}






/****************************************************
 * T√äN D·ª∞ √ÅN: REMOTE SMART ESP32-S3 (v7.2 - HYBRID)
 * T√çNH NƒÇNG:
 * - PHI√äN B·∫¢N v7.2 (Hybrid):
 * - Gi·ªØ nguy√™n Sinric Pro, NTP, H·∫πn gi·ªù H:M:S (c·ªßa v7).
 * - T√≠ch h·ª£p logic "T·ª´ b·ªè" (c·ªßa v12.4) ƒë·ªÉ ·ªïn ƒë·ªãnh AP.
 *
 * KI·∫æN TR√öC HYBRID:
 * - L√µi 1 (Core 1): Ch·∫°y Web Server + DNS.
 * - L√µi 0 (Core 0): Ch·∫°y Task Sinric/NTP/Logic.
 *
 * LOGIC WIFI:
 * 1. AP (Web Server) lu√¥n b·∫≠t tr∆∞·ªõc.
 * 2. Th·ª≠ k·∫øt n·ªëi Internet (STA) trong 15 GI√ÇY.
 * 3. N·∫øu th·∫•t b·∫°i (timeout) -> G·ªçi WiFi.disconnect(true)
 * ƒë·ªÉ T·ª™ B·ªé vƒ©nh vi·ªÖn, tr·∫£ l·∫°i s·ª± ·ªïn ƒë·ªãnh 100% cho AP.
 * 4. N·∫øu ƒëang ch·∫°y m√† m·∫•t m·∫°ng -> C≈©ng T·ª™ B·ªé vƒ©nh vi·ªÖn.
 ****************************************************/

#include <WiFi.h>
#include <WebServer.h>
#include <DNSServer.h>
#include <HTTPClient.h>
#include <Update.h>
#include <Preferences.h>
#include <WiFiClientSecure.h>
#include <SinricPro.h>
#include <SinricProSwitch.h>
#include <time.h> // Th√™m th∆∞ vi·ªán NTP

Preferences prefs;

// === BI·∫æN QU·∫¢N L√ù CHO L√ïI 0 ===
TaskHandle_t NetworkTaskHandle; 
bool isInternetActive = false; 
bool sinricStarted = false; 
// =============================

// ‚öôÔ∏è WiFi
const char* ap_ssid = "Remote Smart";
const char* ap_pass = "12345678";
String saved_ssid = "";
String saved_pass = "";

// ‚öôÔ∏è Sinric Pro (ch·ªâ 3 thi·∫øt b·ªã)
#define APP_KEY       "90c7281e-d20e-4991-9e16-e69dbcd53548"
#define APP_SECRET    "0209ebce-d065-46ff-8d0f-4b975fc8f189-822cdecd-d3a7-4f79-a4d5-919214ece972"
#define SWITCH_ID_1 "68ff3757ba649e246c134f80"
#define SWITCH_ID_2 "68ff55d7ba649e246c135b09"
#define SWITCH_ID_3 "68ff560facd5d3d66b56ba0a"

// ‚öôÔ∏è GPIO
#define PIN_1 4
#define PIN_2 5
#define PIN_3 7
#define PIN_4 16
#define PIN_STOP 13
#define PIN_RESET 14
#define PIN_OTA 1

// ‚öôÔ∏è Bi·∫øn tr·∫°ng th√°i
bool state1, state2, state3, state4;
bool stopAll = false;
unsigned long startTime = 0;

// Bi·∫øn cho NTP
const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = 7 * 3600; // UTC+7
const int daylightOffset_sec = 0;

// ‚öôÔ∏è Bi·∫øn Debounce cho n√∫t v·∫≠t l√Ω
unsigned long lastStopButtonTime = 0;
unsigned long lastResetButtonTime = 0;
const unsigned long DEBOUNCE_DELAY = 100; // 100ms

// ‚öôÔ∏è Bi·∫øn Preferences
const char* PREF_NAMESPACE = "smart_config";
const char* KEY_STOP_ALL = "stop_state";
const char* KEY_WIFI_SSID = "wifi_ssid";
const char* KEY_WIFI_PASS = "wifi_pass";

// === BI·∫æN V√Ä KEY CHO H·∫∏N GI·ªú (H:M:S) ===
long p1_s1_start_s, p1_s1_end_s;
long p1_s2_start_s, p1_s2_end_s;
long p1_s3_start_s, p1_s3_end_s;
long p2_s1_start_s, p2_s1_end_s;
long p2_s2_start_s, p2_s2_end_s;
long p2_s3_start_s, p2_s3_end_s;
long p3_s1_start_s, p3_s1_end_s;
long p3_s2_start_s, p3_s2_end_s;
long p3_s3_start_s, p3_s3_end_s;
// ============================================

// ‚öôÔ∏è Web & DNS
WebServer server(80);
DNSServer dns;

// ‚öôÔ∏è Link OTA
const char* firmware_url = "https://github.com/chuyengamy28-tech/firmware/raw/main/update.bin";

// ====================== STATE PERSISTENCE ======================
void saveState() {
    prefs.begin(PREF_NAMESPACE, false);
    prefs.putBool(KEY_STOP_ALL, stopAll);
    prefs.end();
    Serial.printf("[PREF] ƒê√£ l∆∞u stopAll = %s\n", stopAll ? "TRUE" : "FALSE");
}

void loadState() {
    prefs.begin(PREF_NAMESPACE, true);
    stopAll = prefs.getBool(KEY_STOP_ALL, false);
    prefs.end();
    Serial.printf("[PREF] ƒê√£ t·∫£i stopAll = %s\n", stopAll ? "TRUE" : "FALSE");
}

// === H√ÄM T·∫¢I L·ªäCH H·∫∏N GI·ªú (v7) ===
void loadSchedules() {
    prefs.begin(PREF_NAMESPACE, true); // M·ªü ·ªü ch·∫ø ƒë·ªô read-only
    
    p1_s1_start_s = prefs.getLong("p1s1_on", 0); p1_s1_end_s = prefs.getLong("p1s1_off", 0);
    p1_s2_start_s = prefs.getLong("p1s2_on", 0); p1_s2_end_s = prefs.getLong("p1s2_off", 0);
    p1_s3_start_s = prefs.getLong("p1s3_on", 0); p1_s3_end_s = prefs.getLong("p1s3_off", 0);
    p2_s1_start_s = prefs.getLong("p2s1_on", 0); p2_s1_end_s = prefs.getLong("p2s1_off", 0);
    p2_s2_start_s = prefs.getLong("p2s2_on", 0); p2_s2_end_s = prefs.getLong("p2s2_off", 0);
    p2_s3_start_s = prefs.getLong("p2s3_on", 0); p2_s3_end_s = prefs.getLong("p2s3_off", 0);
    p3_s1_start_s = prefs.getLong("p3s1_on", 0); p3_s1_end_s = prefs.getLong("p3s1_off", 0);
    p3_s2_start_s = prefs.getLong("p3s2_on", 0); p3_s2_end_s = prefs.getLong("p3s2_off", 0);
    p3_s3_start_s = prefs.getLong("p3s3_on", 0); p3_s3_end_s = prefs.getLong("p3s3_off", 0);

    prefs.end();
    Serial.println("[SCHED] ƒê√£ t·∫£i l·ªãch h·∫πn gi·ªù H:M:S t·ª´ Preferences.");
}

// ====================== NTP Setup ======================
void initTime() {
    configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
    Serial.println("[NTP] ƒê√£ c·∫•u h√¨nh NTP (UTC+7)");
}

// ====================== C√ÅC TRANG WEB (Gi·ªØ nguy√™n v7) ======================
void handleSchedulePage() {
    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>C√†i ƒë·∫∑t H·∫πn gi·ªù</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;margin-top:0;} a{text-decoration:none;}";
    html += "form{max-width:500px;margin:0 auto 15px auto;padding:15px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}";
    html += ".timegrid{display:grid;grid-template-columns:30px 30px 30px;gap:5px;justify-content:center;}";
    html += ".timegrid input{width:100%;padding:8px 0;text-align:center;border:1px solid #ccc;border-radius:5px;}";
    html += ".schedgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center;margin-top:10px;}";
    html += ".schedgrid label{font-weight:600;font-size:0.9em;margin:0;}";
    html += ".pin_section h4{color:#1976D2;margin:15px 0 10px 0;border-bottom:1px solid #eee;padding-bottom:5px;}";
    html += ".sched_item h5{margin:10px 0 5px 0;font-size:0.95em;color:#555;}";
    html += "button,.btn{width:auto;min-width:120px;padding:0 15px;height:45px;font-size:16px;font-weight:600;margin:5px;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += "button[type='submit']{background-color:#4CAF50;width:100%;margin-top:15px;}"; // N√∫t L∆∞u
    html += ".home{background-color:#555;display:inline-block;line-height:45px;}"; // N√∫t Quay v·ªÅ
    html += ".note{font-size:0.9em;color:#777;margin-top:15px;}";
    html += "</style></head><body>";
    html += "<h3>C√ÄI ƒê·∫∂T H·∫∏N GI·ªú (H:M:S)</h3>";
    html += "<p class='note'>Nh·∫≠p Gi·ªù(0-23), Ph√∫t(0-59), Gi√¢y(0-59).<br>ƒê·ªÉ B·∫≠t = T·∫Øt (v√≠ d·ª• 0:0:0) ƒë·ªÉ v√¥ hi·ªáu h√≥a l·ªãch ƒë√≥.</p>";

    // Form
    html += "<form action='/save_hengio' method='POST'>";

    // === Lambda helper (gi√∫p code g·ªçn) ===
    auto getHMS = [](long totalSeconds) {
        int h = totalSeconds / 3600;
        totalSeconds %= 3600;
        int m = totalSeconds / 60;
        int s = totalSeconds % 60;
        return String(h) + "," + String(m) + "," + String(s);
    };
    auto addScheduleInputs = [&](String prefix, long start_s, long end_s) {
        String startHMS = getHMS(start_s);
        String endHMS = getHMS(end_s);
        int h_on, m_on, s_on, h_off, m_off, s_off;
        sscanf(startHMS.c_str(), "%d,%d,%d", &h_on, &m_on, &s_on);
        sscanf(endHMS.c_str(), "%d,%d,%d", &h_off, &m_off, &s_off);

        html += "<div class='schedgrid'>";
        html += "<div><label>B·∫¨T (H:M:S)</label><div class='timegrid'>";
        html += "<input type='number' min='0' max='23' name='" + prefix + "_h_on' value='" + h_on + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_m_on' value='" + m_on + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_s_on' value='" + s_on + "'>";
        html += "</div></div>";
        html += "<div><label>T·∫ÆT (H:M:S)</label><div class='timegrid'>";
        html += "<input type='number' min='0' max='23' name='" + prefix + "_h_off' value='" + h_off + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_m_off' value='" + m_off + "'>";
        html += "<input type='number' min='0' max='59' name='" + prefix + "_s_off' value='" + s_off + "'>";
        html += "</div></div>";
        html += "</div>"; // .schedgrid
    };

    // --- Th√™m 3 Ch√¢n ---
    html += "<div class='pin_section'>";
    html += "<h4>·ªî c·∫Øm 1 (t√™n m√°y)</h4>";
    html += "<h5>L·ªãch 1</h5>"; addScheduleInputs("p1s1", p1_s1_start_s, p1_s1_end_s);
    html += "<h5>L·ªãch 2</h5>"; addScheduleInputs("p1s2", p1_s2_start_s, p1_s2_end_s);
    html += "<h5>L·ªãch 3</h5>"; addScheduleInputs("p1s3", p1_s3_start_s, p1_s3_end_s);
    html += "</div>";

    html += "<div class='pin_section'>";
    html += "<h4>·ªî c·∫Øm 2 (t√™n m√°y)</h4>";
    html += "<h5>L·ªãch 1</h5>"; addScheduleInputs("p2s1", p2_s1_start_s, p2_s1_end_s);
    html += "<h5>L·ªãch 2</h5>"; addScheduleInputs("p2s2", p2_s2_start_s, p2_s2_end_s);
    html += "<h5>L·ªãch 3</h5>"; addScheduleInputs("p2s3", p2_s3_start_s, p2_s3_end_s);
    html += "</div>";

    html += "<div class='pin_section'>";
    html += "<h4>·ªî c·∫Øm 3 (t√™n m√°y)</h4>";
    html += "<h5>L·ªãch 1</h5>"; addScheduleInputs("p3s1", p3_s1_start_s, p3_s1_end_s);
    html += "<h5>L·ªãch 2</h5>"; addScheduleInputs("p3s2", p3_s2_start_s, p3_s2_end_s);
    html += "<h5>L·ªãch 3</h5>"; addScheduleInputs("p3s3", p3_s3_start_s, p3_s3_end_s);
    html += "</div>";

    html += "<p class='note' style='color:red;font-weight:bold;'>Ch√¢n 16 (PIN_4) ch·ªâ ƒëi·ªÅu khi·ªÉn b·∫±ng tay.</p>";

    html += "<button type='submit'>L∆∞u C√†i ƒê·∫∑t</button>";
    html += "</form>";
    html += "<a href='/' class='btn home'>Quay v·ªÅ trang ch·ªß</a>";
    html += "</body></html>";
    server.send(200, "text/html", html);
}
void handleSaveSchedule() {
    Serial.println("[WEB] ƒêang nh·∫≠n l·ªãch h·∫πn gi·ªù H:M:S m·ªõi...");
    auto getSecondsFromForm = [&](String prefix, String type) {
        long h = server.arg(prefix + "_h_" + type).toInt();
        long m = server.arg(prefix + "_m_" + type).toInt();
        long s = server.arg(prefix + "_s_" + type).toInt();
        return (h * 3600) + (m * 60) + s;
    };
    p1_s1_start_s = getSecondsFromForm("p1s1", "on"); p1_s1_end_s = getSecondsFromForm("p1s1", "off");
    p1_s2_start_s = getSecondsFromForm("p1s2", "on"); p1_s2_end_s = getSecondsFromForm("p1s2", "off");
    p1_s3_start_s = getSecondsFromForm("p1s3", "on"); p1_s3_end_s = getSecondsFromForm("p1s3", "off");
    p2_s1_start_s = getSecondsFromForm("p2s1", "on"); p2_s1_end_s = getSecondsFromForm("p2s1", "off");
    p2_s2_start_s = getSecondsFromForm("p2s2", "on"); p2_s2_end_s = getSecondsFromForm("p2s2", "off");
    p2_s3_start_s = getSecondsFromForm("p2s3", "on"); p2_s3_end_s = getSecondsFromForm("p2s3", "off");
    p3_s1_start_s = getSecondsFromForm("p3s1", "on"); p3_s1_end_s = getSecondsFromForm("p3s1", "off");
    p3_s2_start_s = getSecondsFromForm("p3s2", "on"); p3_s2_end_s = getSecondsFromForm("p3s2", "off");
    p3_s3_start_s = getSecondsFromForm("p3s3", "on"); p3_s3_end_s = getSecondsFromForm("p3s3", "off");
    prefs.begin(PREF_NAMESPACE, false); // M·ªü ch·∫ø ƒë·ªô read-write
    prefs.putLong("p1s1_on", p1_s1_start_s); prefs.putLong("p1s1_off", p1_s1_end_s);
    prefs.putLong("p1s2_on", p1_s2_start_s); prefs.putLong("p1s2_off", p1_s2_end_s);
    prefs.putLong("p1s3_on", p1_s3_start_s); prefs.putLong("p1s3_off", p1_s3_end_s);
    prefs.putLong("p2s1_on", p2_s1_start_s); prefs.putLong("p2s1_off", p2_s1_end_s);
    prefs.putLong("p2s2_on", p2_s2_start_s); prefs.putLong("p2s2_off", p2_s2_end_s);
    prefs.putLong("p2s3_on", p2_s3_start_s); prefs.putLong("p2s3_off", p2_s3_end_s);
    prefs.putLong("p3s1_on", p3_s1_start_s); prefs.putLong("p3s1_off", p3_s1_end_s);
    prefs.putLong("p3s2_on", p3_s2_start_s); prefs.putLong("p3s2_off", p3_s2_end_s);
    prefs.putLong("p3s3_on", p3_s3_start_s); prefs.putLong("p3s3_off", p3_s3_end_s);
    prefs.end();
    Serial.println("[SCHED] ƒê√£ l∆∞u 18 m·ªëc H:M:S v√†o Preferences.");
    String html = "<html><head><meta charset='utf-8'><title>ƒêang l∆∞u</title>";
    html += "<meta http-equiv='refresh' content='2;url=/'></head>"; // T·ª± chuy·ªÉn h∆∞·ªõng sau 2s
    html += "<body><p style='font-family:sans-serif;text-align:center;margin-top:30px;font-size:1.2em;'>";
    html += "‚úÖ ƒê√£ l∆∞u h·∫πn gi·ªù H:M:S!<br>ƒêang quay v·ªÅ trang ch·ªß...</p></body></html>";
    server.send(200, "text/html", html);
}
void handleWifiSettings() {
    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>C√†i ƒë·∫∑t WiFi</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;margin-top:0;}";
    html += "a{text-decoration:none;}";
    html += "form{max-width:350px;margin:0 auto;padding:20px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}";
    html += "input[type='text'],input[type='password'],select{width:100%;box-sizing:border-box;padding:12px;margin:10px 0;border:1px solid #ccc;border-radius:8px;font-size:16px;}";
    html += "button,.btn{width:auto;min-width:120px;padding:0 15px;height:45px;font-size:16px;font-weight:600;margin:5px;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += "button[type='submit']{background-color:#2196F3;width:100%;}"; // N√∫t L∆∞u
    html += ".scan{background-color:#FF9800;}"; // N√∫t Qu√©t
    html += ".home{background-color:#555;display:inline-block;line-height:45px;margin-top:15px;}";
    html += "</style>";
    html += "</head><body>";
    html += "<form action='/savewifi' method='POST'>";
    html += "<h3>C√ÄI ƒê·∫∂T WIFI</h3>";
    if (WiFi.status() == WL_CONNECTED) {
        html += "<p style='color:green;'>ƒêang k·∫øt n·ªëi: <strong>" + WiFi.SSID() + "</strong></p>";
    } else {
        html += "<p style='color:red;'>Ch∆∞a k·∫øt n·ªëi WiFi</p>";
    }
    html += "<input id='ssid' name='ssid' type='text' placeholder='T√™n WiFi (SSID)' value='" + saved_ssid + "'>";
    html += "<input name='pass' type='password' placeholder='M·∫≠t kh·∫©u WiFi'>";
    html += "<button type='submit'>L∆∞u & Kh·ªüi ƒë·ªông l·∫°i</button>";
    html += "</form>";
    html += "<form action='/wifi_scan_results' method='GET' style='margin-top:15px;padding:15px;'>";
    html += "<h4 style='margin:15px 0 5px 0;'>Kh√¥ng nh·ªõ t√™n?</h4>";
    html += "<button class='scan' type='submit'>Qu√©t WiFi ƒë·ªÉ ch·ªçn</button>";
    html += "</form>";
    html += "<a href='/' class='btn home'>Quay v·ªÅ trang ch·ªß</a>";
    html += "</body></html>";
    server.send(200, "text/html", html);
}
void handleWifiScanResults() {
    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>Qu√©t WiFi</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;margin-top:0;}";
    html += "a{text-decoration:none;}";
    html += "form{max-width:350px;margin:0 auto;padding:20px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);}";
    html += "input[type='text'],input[type='password'],select{width:100%;box-sizing:border-box;padding:12px;margin:10px 0;border:1px solid #ccc;border-radius:8px;font-size:16px;}";
    html += "button,.btn{width:auto;min-width:120px;padding:0 15px;height:45px;font-size:16px;font-weight:600;margin:5px;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += ".scan{background-color:#FF9800;}"; // N√∫t Qu√©t
    html += ".home{background-color:#555;display:inline-block;line-height:45px;margin-top:15px;}";
    html += "h4{margin:15px 0 5px 0;}";
    html += "</style>";
    html += "<script>";
    html += "function sel(v){ var el = document.getElementById('selected_ssid_text'); if(el) el.innerHTML = 'ƒê√£ ch·ªçn: <strong>' + v + '</strong><br>Quay l·∫°i trang tr∆∞·ªõc ƒë·ªÉ L∆∞u.'; }";
    html += "</script>";
    html += "</head><body>";
    html += "<div style='max-width:350px;margin:0 auto;'>";
    html += "<h3>K·∫æT QU·∫¢ QU√âT WIFI</h3>";
    html += "<p>ƒêang qu√©t... vui l√≤ng ch·ªù.</p>";
    html += "<form action='/wifi_scan_results' method='GET' style='padding:15px;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);'>";
    html += "<button class='scan' type='submit'>Qu√©t l·∫°i</button>";
    Serial.println("[WIFI] T·∫°m ng·∫Øt STA ƒë·ªÉ ∆∞u ti√™n qu√©t...");
    WiFi.disconnect();
    delay(100);
    Serial.println("[WIFI] B·∫Øt ƒë·∫ßu qu√©t m·∫°ng...");
    int n = WiFi.scanNetworks();
    Serial.printf("[WIFI] Qu√©t xong, t√¨m th·∫•y %d m·∫°ng.\n", n);
    Serial.println("[WIFI] Kh·ªüi ƒë·ªông l·∫°i k·∫øt n·ªëi STA...");
    if (saved_ssid.length() > 0) {
         WiFi.begin(saved_ssid.c_str(), saved_pass.c_str());
    }
    if (n > 0) {
        html += "<h4>T√¨m th·∫•y " + String(n) + " m·∫°ng:</h4>";
        html += "<select onchange='sel(this.value)'>";
        html += "<option value=''>-- Ch·ªçn m·∫°ng --</option>";
        for (int i = 0; i < n; ++i) {
            html += "<option value='" + WiFi.SSID(i) + "'>" + WiFi.SSID(i) + " (" + WiFi.RSSI(i) + "dBm)</option>";
        }
        html += "</select>";
        html += "<p id='selected_ssid_text' style='margin-top:10px;color:green;'></p>";
    } else {
        html += "<p>Kh√¥ng t√¨m th·∫•y m·∫°ng WiFi n√†o.</p>";
    }
    html += "</form>";
    html += "<a href='/wifi' class='btn home'>Quay l·∫°i C√†i ƒë·∫∑t</a>";
    html += "</div></body></html>";
    server.send(200, "text/html", html);
}
void handleSaveWifi() {
    String ssid = server.arg("ssid");
    String pass = server.arg("pass");
    Serial.println("[WIFI] ƒêang l∆∞u c√†i ƒë·∫∑t WiFi m·ªõi...");
    Serial.println("SSID: " + ssid);
    prefs.begin(PREF_NAMESPACE, false);
    prefs.putString(KEY_WIFI_SSID, ssid);
    prefs.putString(KEY_WIFI_PASS, pass);
    prefs.end();
    String html = "<html><head><meta charset='utf-8'><title>ƒêang l∆∞u</title>";
    html += "<meta http-equiv='refresh' content='5;url=/'></head>"; // T·ª± chuy·ªÉn h∆∞·ªõng sau 5s
    html += "<body><p>ƒê√£ l∆∞u WiFi! ƒêang kh·ªüi ƒë·ªông l·∫°i...</p></body></html>";
    server.send(200, "text/html", html);
    delay(2000);
    ESP.restart();
}
String htmlPage() {
    String timeStr = "ƒêang ch·ªù ƒë·ªìng b·ªô gi·ªù...";
    if (isInternetActive) {
      struct tm timeinfo;
      time_t now;
      time(&now);
      localtime_r(&now, &timeinfo);
      if (timeinfo.tm_year > (2000 - 1900)) { // Ki·ªÉm tra gi·ªù h·ª£p l·ªá
          char timeBuffer[50];
          strftime(timeBuffer, 50, "%H:%M:%S | %d/%m/%Y", &timeinfo);
          timeStr = String(timeBuffer);
      }
    }

    String html = "<!DOCTYPE html><html><head><meta charset='utf-8'>";
    html += "<meta name='viewport' content='width=device-width,initial-scale=1'>";
    html += "<title>Remote Smart (v7.2)</title><style>";
    html += "body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;text-align:center;background:#f0f2f5;margin:0;padding:15px;}";
    html += "h3{color:#333;}";
    html += "a{text-decoration:none;}";
    html += ".container{max-width:800px;margin:0 auto;}";
    html += ".status{margin-bottom:20px;padding:15px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);line-height:1.7;text-align:left;}";
    html += ".status strong{color:#555;}";
    html += ".grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:20px;}";
    html += ".card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;flex-direction:column;justify-content:space-between;}";
    html += ".card h4{margin:0 0 10px 0;color:#333;font-size:1em;}";
    html += "button,.btn{width:100%;height:45px;font-size:16px;font-weight:600;margin:5px 0 0 0;border:none;border-radius:10px;color:white;cursor:pointer;transition:transform 0.1s ease;}";
    html += "button:active,.btn:active{transform:scale(0.95);}";
    html += ".on{background-color:#4CAF50;}";
    html += ".off{background-color:#f44336;}";
    html += ".control{background-color:#2196F3;}";
    html += ".ota{background-color:#FF9800;}"; // M√†u cam
    html += ".wifi{background-color:#555;}"; // M√†u x√°m
    html += "</style></head><body>";

    html += "<div class='container'>";
    html += "<h3>H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN (v7.2 Hybrid)</h3>";

    // --- Card Tr·∫°ng th√°i ---
    html += "<div class='status'>";
    if (WiFi.status() == WL_CONNECTED) {
        html += "<strong>WIFI: </strong><span style='color:green;'>" + WiFi.SSID() + " (" + WiFi.localIP().toString() + ")</span><br>";
        if (!isInternetActive) {
            html += "<strong>INTERNET: </strong><span style='color:orange;'>ƒêang ki·ªÉm tra (NTP)...</span><br>";
        } else {
             if (!sinricStarted) {
                html += "<strong>INTERNET: </strong><span style='color:orange;'>ƒêang k·∫øt n·ªëi Sinric...</span><br>";
             } else {
                if (SinricPro.isConnected()) {
                    html += "<strong>INTERNET: </strong><span style='color:green;'>ƒê√£ k·∫øt n·ªëi (Sinric/NTP)</span><br>";
                } else {
                    html += "<strong>INTERNET: </strong><span style='color:red;'>M·∫•t k·∫øt n·ªëi Sinric!</span><br>";
                }
             }
        }
    } else {
        html += "<strong>WIFI: </strong><span style='color:red;'>Ch∆∞a k·∫øt n·ªëi (AP: " + WiFi.softAPIP().toString() + ")</span><br>";
        if(isInternetActive) { // Tr∆∞·ªùng h·ª£p ƒë√£ T·ª™ B·ªé
            html += "<strong>INTERNET: </strong><span style='color:red;'>ƒê√£ T·ª™ B·ªé (AP ·ªîn ƒë·ªãnh)</span><br>";
        }
    }
    html += "<strong>GI·ªú NTP: </strong>" + timeStr + "<br>";
    String status_text = stopAll ? "<span style='color:#f44336;'>ƒêANG D·ª™NG</span>" : "<span style='color:#4CAF50;'>ƒêANG CH·∫†Y</span>";
    html += "<strong>T·ª∞ ƒê·ªòNG: </strong>" + status_text + "</div>";

    // --- L∆∞·ªõi c√°c n√∫t ---
    html += "<div class='grid'>";

    auto addBtnCard = [&](String name, bool state, String url, String cssClass = "") {
        String cls = cssClass.isEmpty() ? (state ? "on" : "off") : cssClass;
        String label = (cssClass == "control" || cssClass == "ota" || cssClass == "wifi") ? name : (state ? "ON" : "OFF");
        html += "<div class='card'>";
        html += "<h4>" + name + "</h4>";
        html += "<button class='" + cls + "' onclick=\"location.href='" + url + "'\">" + label + "</button>";
        html += "</div>";
    };

    addBtnCard("·ªî c·∫Øm 1 (t√™n m√°y)", state1, "/toggle1");
    addBtnCard("·ªî c·∫Øm 2 (t√™n m√°y)", state2, "/toggle2");
    addBtnCard("·ªî c·∫Øm 3 (t√™n m√°y)", state3, "/toggle3");
    addBtnCard("·ªî c·∫Øm 4 (t√™n m√°y)", state4, "/toggle4"); 

    addBtnCard(stopAll ? "B·∫≠t t·ª± ƒë·ªông" : "D·ª´ng t·ª± ƒë·ªông", stopAll, "/toggleStop", "control");
    addBtnCard("Kh·ªüi ƒë·ªông l·∫°i", false, "/resetAuto", "control");
    addBtnCard("C√†i ƒë·∫∑t H·∫πn gi·ªù", false, "/hengio", "ota"); 
    addBtnCard("C√†i ƒë·∫∑t WiFi", false, "/wifi", "wifi"); 

    html += "</div>"; 
    html += "<div class='grid' style='grid-template-columns:1fr;'>";
    addBtnCard("C·∫≠p nh·∫≠t FW", false, "/otaUpdate", "ota");
    html += "</div>";
    
    html += "</div>"; 
    html += "</body></html>";
    return html;
}

// ====================== OTA ======================
void performOTA() {
    if (WiFi.status() != WL_CONNECTED) {
        Serial.println("‚ùå Kh√¥ng c√≥ WiFi ƒë·ªÉ OTA");
        return;
    }
    WiFiClientSecure client;
    client.setInsecure();
    HTTPClient https;
    Serial.println("üîó K·∫øt n·ªëi ƒë·∫øn GitHub...");
    if (!https.begin(client, firmware_url)) {
        Serial.println("‚ùå Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu k·∫øt n·ªëi HTTPS!");
        return;
    }
    int httpCode = https.GET();
    if (httpCode == HTTP_CODE_FOUND || httpCode == HTTP_CODE_MOVED_PERMANENTLY) {
        String newURL = https.getLocation();
        Serial.println("‚û°Ô∏è Chuy·ªÉn h∆∞·ªõng ƒë·∫øn: " + newURL);
        https.end();
        if (!https.begin(client, newURL)) return;
        httpCode = https.GET();
    }
    if (httpCode == HTTP_CODE_OK) {
        int contentLength = https.getSize();
        WiFiClient *stream = https.getStreamPtr();
        if (contentLength > 0 && Update.begin(contentLength)) {
            Serial.printf("üì¶ Firmware: %d bytes\n", contentLength);
            size_t written = Update.writeStream(*stream);
            Serial.printf("üìù ƒê√£ ghi: %d bytes\n", written);
            if (written == contentLength && Update.end(true)) {
                Serial.println("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng! Kh·ªüi ƒë·ªông l·∫°i...");
                delay(1000);
                ESP.restart();
            }
        } else {
            Serial.println("‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i ho·∫∑c file qu√° l·ªõn!");
        }
    } else {
        Serial.printf("‚ùå L·ªói t·∫£i Firmware, HTTP code: %d\n", httpCode);
    }
    https.end();
}

// ====================== Sinric Handler ======================
bool onPowerState1(const String &deviceId, bool &state) {
    if (!stopAll) {
        Serial.println("‚ö†Ô∏è L·ªánh Sinric Pro b·ªã b·ªè qua do Auto Control ƒëang ch·∫°y!");
        state = state1;
        return false;
    }
    digitalWrite(PIN_1, state);
    state1 = state;
    Serial.printf("[SINRIC] Ch√¢n 4: %s\n", state ? "ON" : "OFF");
    return true;
}
bool onPowerState2(const String &deviceId, bool &state) {
    if (!stopAll) {
        Serial.println("‚ö†Ô∏è L·ªánh Sinric Pro b·ªã b·ªè qua do Auto Control ƒëang ch·∫°y!");
        state = state2;
        return false;
    }
    digitalWrite(PIN_2, state);
    state2 = state;
    Serial.printf("[SINRIC] Ch√¢n 5: %s\n", state ? "ON" : "OFF");
    return true;
}
bool onPowerState3(const String &deviceId, bool &state) {
    if (!stopAll) {
        Serial.println("‚ö†Ô∏è L·ªánh Sinric Pro b·ªã b·ªè qua do Auto Control ƒëang ch·∫°y!");
        state = state3;
        return false;
    }
    digitalWrite(PIN_3, state);
    state3 = state;
    Serial.printf("[SINRIC] Ch√¢n 7: %s\n", state ? "ON" : "OFF");
    return true;
}


// === H√ÄM AUTOCONTROL (v7 - 3 Ch√¢n, 3 L·ªãch, H:M:S) ===
void autoControl() {
    if (stopAll) return;

    time_t now;
    time(&now);
    struct tm timeinfo;
    localtime_r(&now, &timeinfo);

    if (timeinfo.tm_year < (2024 - 1900)) {
        return; // Gi·ªù NTP ch∆∞a s·∫µn s√†ng
    }

    long currentTimeInSeconds = (timeinfo.tm_hour * 3600) + (timeinfo.tm_min * 60) + timeinfo.tm_sec;
    auto getTargetState = [&](long startSec, long endSec) {
        if (startSec == endSec) return false; 
        if (startSec < endSec) {
            return (currentTimeInSeconds >= startSec) && (currentTimeInSeconds < endSec);
        } else {
            return (currentTimeInSeconds >= startSec) || (currentTimeInSeconds < endSec);
        }
    };

    // --- L·ªãch t·ª± ƒë·ªông cho Ch√¢n 4 (PIN_1) ---
    bool targetState1 = getTargetState(p1_s1_start_s, p1_s1_end_s) ||
                        getTargetState(p1_s2_start_s, p1_s2_end_s) ||
                        getTargetState(p1_s3_start_s, p1_s3_end_s);
    if (targetState1 != state1) {
        state1 = targetState1;
        digitalWrite(PIN_1, state1);
        if (sinricStarted) ((SinricProSwitch&)SinricPro[SWITCH_ID_1]).sendPowerStateEvent(state1);
        Serial.printf("[AUTO] Ch√¢n 4: %s\n", state1 ? "B·∫¨T" : "T·∫ÆT");
    }

    // --- L·ªãch t·ª± ƒë·ªông cho Ch√¢n 5 (PIN_2) ---
    bool targetState2 = getTargetState(p2_s1_start_s, p2_s1_end_s) ||
                        getTargetState(p2_s2_start_s, p2_s2_end_s) ||
                        getTargetState(p2_s3_start_s, p2_s3_end_s);
    if (targetState2 != state2) {
        state2 = targetState2;
        digitalWrite(PIN_2, state2);
        if (sinricStarted) ((SinricProSwitch&)SinricPro[SWITCH_ID_2]).sendPowerStateEvent(state2);
        Serial.printf("[AUTO] Ch√¢n 5: %s\n", state2 ? "B·∫¨T" : "T·∫ÆT");
    }

    // --- L·ªãch t·ª± ƒë·ªông cho Ch√¢n 7 (PIN_3) ---
    bool targetState3 = getTargetState(p3_s1_start_s, p3_s1_end_s) ||
                        getTargetState(p3_s2_start_s, p3_s2_end_s) ||
                        getTargetState(p3_s3_start_s, p3_s3_end_s);
    if (targetState3 != state3) {
        state3 = targetState3;
        digitalWrite(PIN_3, state3);
        if (sinricStarted) ((SinricProSwitch&)SinricPro[SWITCH_ID_3]).sendPowerStateEvent(state3);
        Serial.printf("[AUTO] Ch√¢n 7: %s\n", state3 ? "B·∫¨T" : "T·∫ÆT");
    }
}


// === [HYBRID v7.2] T√ÅC V·ª§ L√ïI 0 (ƒê√É TH√äM LOGIC "T·ª™ B·ªé") ===
void networkTask(void *pvParameters) {
    Serial.println("[TASK] T√°c v·ª• M·∫°ng ƒë√£ kh·ªüi ƒë·ªông tr√™n L√µi 0.");
    initTime(); 

    unsigned long lastNtpCheck = 0;
    unsigned long lastAutoControl = 0;

    for (;;) { 
        if (WiFi.status() != WL_CONNECTED) {
            
            if (sinricStarted) {
                // [HYBRID v7.2] ƒê√£ t·ª´ng k·∫øt n·ªëi, nh∆∞ng gi·ªù b·ªã m·∫•t.
                // T·ª™ B·ªé vƒ©nh vi·ªÖn ƒë·ªÉ AP (L√µi 1) ·ªïn ƒë·ªãnh.
                Serial.println("[TASK] üî¥ M·∫•t k·∫øt n·ªëi. T·ª™ B·ªé vƒ©nh vi·ªÖn (g·ªçi WiFi.disconnect) ƒë·ªÉ AP ·ªïn ƒë·ªãnh.");
                WiFi.disconnect(true); // <-- "GIVE UP" KEY
                sinricStarted = false; 
                isInternetActive = false;
            }
            
            // N·∫øu 'sinricStarted' l√† false, nghƒ©a l√† ta ch∆∞a bao gi·ªù k·∫øt n·ªëi
            // (do 'setup' th·∫•t b·∫°i V√Ä ƒë√£ g·ªçi disconnect). 
            // Ch·ªâ c·∫ßn im l·∫∑ng v√† kh√¥ng l√†m g√¨ c·∫£.
            vTaskDelay(1000 / portTICK_PERIOD_MS); 
            continue; 
        }

        // === PH·∫¶N CODE V7 B√åNH TH∆Ø·ªúNG KHI C√ì M·∫†NG ===
        
        // 1. Ki·ªÉm tra NTP
        if (!isInternetActive || (millis() - lastNtpCheck > 10000)) { 
            Serial.println("[TASK] C√≥ WiFi, ƒëang ki·ªÉm tra Internet (NTP)...");
            struct tm timeinfo;
            if (getLocalTime(&timeinfo, 2000)) { 
                if (!isInternetActive) {
                    Serial.printf("[TASK] ‚úÖ ƒê√£ ƒë·ªìng b·ªô gi·ªù NTP: %02d:%02d:%02d\n", timeinfo.tm_hour, timeinfo.tm_min, timeinfo.tm_sec);
                    isInternetActive = true; 
                }
            } else {
                Serial.println("[TASK] ‚ùå NTP th·∫•t b·∫°i (ch∆∞a c√≥ Internet).");
                isInternetActive = false;
            }
            lastNtpCheck = millis(); 
        }

        // 2. Kh·ªüi ƒë·ªông Sinric
        if (isInternetActive && !sinricStarted) {
            Serial.println("[TASK] C√≥ th·ªùi gian, ƒëang th·ª≠ SinricPro.begin()...");
            SinricPro.begin(APP_KEY, APP_SECRET);
            Serial.println("[TASK] SinricPro.begin() ƒë√£ ch·∫°y xong.");
            sinricStarted = true;
        }

        // 3. Ch·∫°y Sinric Handle
        if (sinricStarted) {
            SinricPro.handle();
        }

        // 4. Ch·∫°y AutoControl (H·∫πn gi·ªù)
        if (isInternetActive && (millis() - lastAutoControl > 1000)) {
            autoControl(); // G·ªçi h√†m autoControl (v7) m·ªõi
            lastAutoControl = millis();
        }
        
        vTaskDelay(50 / portTICK_PERIOD_MS);
    }
}
// ===================================


// ====================== [HYBRID v7.2] SETUP ======================
void setup() {
    Serial.begin(115200);

    loadState(); 
    loadSchedules(); 

    prefs.begin(PREF_NAMESPACE, true);
    saved_ssid = prefs.getString(KEY_WIFI_SSID, "");
    saved_pass = prefs.getString(KEY_WIFI_PASS, "");
    prefs.end();

    pinMode(PIN_1, OUTPUT); digitalWrite(PIN_1, LOW);
    pinMode(PIN_2, OUTPUT); digitalWrite(PIN_2, LOW);
    pinMode(PIN_3, OUTPUT); digitalWrite(PIN_3, LOW);
    pinMode(PIN_4, OUTPUT); digitalWrite(PIN_4, LOW);
    pinMode(PIN_STOP, INPUT_PULLUP);
    pinMode(PIN_RESET, INPUT_PULLUP);
    pinMode(PIN_OTA, INPUT_PULLUP);

    state1 = state2 = state3 = state4 = LOW;
    startTime = millis();

    // === [HYBRID v7.2] LOGIC WIFI M·ªöI (T·ª´ v12.4) ===
      
    Serial.println("üîÑ Kh·ªüi ƒë·ªông ·ªü ch·∫ø ƒë·ªô AP+STA...");
    WiFi.disconnect(true); // D·ªçn d·∫πp
    WiFi.mode(WIFI_AP_STA); 

    // 1. C·∫•u h√¨nh v√† B·∫¨T AP (Lu√¥n lu√¥n ch·∫°y tr∆∞·ªõc)
    Serial.println("[AP] B·∫≠t AP 'Remote Smart' (K√™nh t·ª± ƒë·ªông)...");
    if (!WiFi.softAP(ap_ssid, ap_pass)) { // <-- X√ìA K√äNH 6
         Serial.println("‚ùå L·ªói kh·ªüi ƒë·ªông softAP!");
    }
    
    delay(100);
    dns.start(53, "*", WiFi.softAPIP());
    Serial.println("‚úÖ AP (L√µi 1) ƒë√£ kh·ªüi ƒë·ªông: " + String(ap_ssid));
    Serial.print("IP AP: "); Serial.println(WiFi.softAPIP());
    
    // 2. TH·ª¨ K·∫æT N·ªêI STA (v·ªõi 15s Timeout)
    if (saved_ssid.length() > 0) {
        Serial.printf("üì° ƒêang th·ª≠ k·∫øt n·ªëi STA (15s timeout) ƒë·∫øn: %s...\n", saved_ssid.c_str());
        WiFi.begin(saved_ssid.c_str(), saved_pass.c_str());

        unsigned long startTime = millis();
        bool timeout = false;
        
        while (WiFi.status() != WL_CONNECTED) {
            delay(500); 
            Serial.print(".");
            if (millis() - startTime > 15000) { // 15 GI√ÇY TIMEOUT
                Serial.println("\n‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi STA (Timeout)!");
                timeout = true;
                break; 
            }
        }

        if (timeout == false) {
            Serial.println("\n‚úÖ WiFi (STA) ƒë√£ k·∫øt n·ªëi!");
            Serial.print("IP: "); Serial.println(WiFi.localIP());
        } else {
             // === [HYBRID v7.2] T·ª™ B·ªé K·∫æT N·ªêI ƒê·ªÇ AP ·ªîN ƒê·ªäNH ===
             Serial.println("[FIX] D·ª´ng h·∫≥n vi·ªác th·ª≠ k·∫øt n·ªëi STA (ƒë·ªÉ AP ch·∫°y m∆∞·ª£t).");
             WiFi.disconnect(true); // <-- "GIVE UP" KEY
        }

    } else {
        Serial.println("‚ÑπÔ∏è Kh√¥ng c√≥ WiFi STA n√†o ƒë∆∞·ª£c l∆∞u. Ch·ªâ ch·∫°y AP.");
    }
    // === K·∫æT TH√öC LOGIC WIFI HYBRID ===


    // Khai b√°o Web Server Handlers (CH·∫†Y TR√äN L√ïI 1)
    server.on("/", [](){ server.send(200, "text/html", htmlPage()); });
    server.on("/hengio", HTTP_GET, handleSchedulePage);
    server.on("/save_hengio", HTTP_POST, handleSaveSchedule);
    
    // Toggle 1
    server.on("/toggle1", [](){
        if (stopAll) { // Ch·ªâ cho ph√©p ƒëi·ªÅu khi·ªÉn tay khi Auto D·ª™NG
            state1 = !state1; digitalWrite(PIN_1, state1);
            if(sinricStarted) ((SinricProSwitch&)SinricPro[SWITCH_ID_1]).sendPowerStateEvent(state1);
        }
        server.sendHeader("Location", "/"); server.send(303);
    });
    // Toggle 2
    server.on("/toggle2", [](){
        if (stopAll) {
            state2 = !state2; digitalWrite(PIN_2, state2);
            if(sinricStarted) ((SinricProSwitch&)SinricPro[SWITCH_ID_2]).sendPowerStateEvent(state2);
        }
        server.sendHeader("Location", "/"); server.send(303);
    });
    // Toggle 3
    server.on("/toggle3", [](){
        if (stopAll) {
            state3 = !state3; digitalWrite(PIN_3, state3);
            if(sinricStarted) ((SinricProSwitch&)SinricPro[SWITCH_ID_3]).sendPowerStateEvent(state3);
        }
        server.sendHeader("Location", "/"); server.send(303);
    });
    // Toggle 4 (Ch√¢n 16)
    server.on("/toggle4", [](){
        if (stopAll) {
            state4 = !state4;
            digitalWrite(PIN_4, state4);
            Serial.printf("[WEB] Ch√¢n 16 (PIN_4) ƒë√£ chuy·ªÉn sang: %s\n", state4 ? "ON" : "OFF");
        } else {
            Serial.println("[WEB] Ch√¢n 16 b·ªã ch·∫∑n do Auto Control ƒëang ch·∫°y!");
        }
        server.sendHeader("Location", "/"); server.send(303);
    });

    // C√°c n√∫t control
    server.on("/toggleStop", [](){
        stopAll = !stopAll;
        saveState();
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/resetAuto", [](){
        startTime = millis();
        stopAll = false;
        saveState();
        server.sendHeader("Location", "/"); server.send(303);
    });
    server.on("/otaUpdate", [](){ 
        if (WiFi.status() != WL_CONNECTED) {
            server.send(200, "text/html", "<h3>L·ªñI: Ph·∫£i k·∫øt n·ªëi WiFi (STA) tr∆∞·ªõc khi c·∫≠p nh·∫≠t!</h3>");
            return;
        }
        server.send(200, "text/html", "<h3>ƒêang c·∫≠p nh·∫≠t firmware...</h3>"); 
        performOTA(); 
    });

    // C√°c handler WiFi
    server.on("/wifi", HTTP_GET, handleWifiSettings); 
    server.on("/wifi_scan_results", HTTP_GET, handleWifiScanResults); 
    server.on("/savewifi", HTTP_POST, handleSaveWifi); 

    // Captive Portal
    server.onNotFound([]() {
        if (WiFi.status() != WL_CONNECTED && saved_ssid.length() == 0) {
             server.sendHeader("Location", "http://" + WiFi.softAPIP().toString() + "/wifi", true);
             server.send(302, "text/plain", "");
        } else {
             server.sendHeader("Location", "http://" + WiFi.softAPIP().toString() + "/", true);
             server.send(302, "text/plain", "");
        }
    });

    server.begin();

    // SinricPro setup
    SinricProSwitch &device1 = SinricPro[SWITCH_ID_1];
    SinricProSwitch &device2 = SinricPro[SWITCH_ID_2];
    SinricProSwitch &device3 = SinricPro[SWITCH_ID_3];
    device1.onPowerState(onPowerState1);
    device2.onPowerState(onPowerState2);
    device3.onPowerState(onPowerState3);

    Serial.println("‚úÖ ESP32-S3 (v7.2 Hybrid) ƒë√£ kh·ªüi ƒë·ªông ho√†n t·∫•t!");

    // === KH·ªûI ƒê·ªòNG T√ÅC V·ª§ L√ïI 0 ===
    xTaskCreatePinnedToCore(
        networkTask,        /* H√†m ƒë·ªÉ ch·∫°y Task */
        "NetworkTask",      /* T√™n c·ªßa Task (ƒë·ªÉ debug) */
        12000,              /* K√≠ch th∆∞·ªõc Stack */
        NULL,               /* Tham s·ªë ƒë·∫ßu v√†o cho Task */
        1,                  /* ∆Øu ti√™n (priority) */
        &NetworkTaskHandle, /* Handle c·ªßa Task */
        0                   /* Ghim v√†o L√µi 0 (Core 0) */
    );
}

// ====================== LOOP (L√ïI 1 - SI√äU NHANH) ======================
void loop() {
    dns.processNextRequest();
    server.handleClient();

    unsigned long now = millis();
    bool stateChanged = false;

    // N√∫t D·ª™NG Auto (PIN_STOP - GPIO 8)
    if (digitalRead(PIN_STOP) == LOW) {
        if (now - lastStopButtonTime > DEBOUNCE_DELAY) {
            if (!stopAll) {
                stopAll = true;
                stateChanged = true;
                Serial.println("[BUTTON] Auto Control D·ª™NG (PIN_STOP)");
            }
        }
        lastStopButtonTime = now;
    }

    // N√∫t KH·ªûI ƒê·ªòNG/B·∫¨T Auto (PIN_RESET - GPIO 9)
    if (digitalRead(PIN_RESET) == LOW) {
        if (now - lastResetButtonTime > DEBOUNCE_DELAY) {
            if (stopAll) {
                startTime = now;
                stopAll = false;
                stateChanged = true;
                Serial.println("[BUTTON] Auto Control B·∫¨T (PIN_RESET)");
            }
        }
        lastResetButtonTime = now;
    }

    if (stateChanged) {
        saveState();
    }

    // N√∫t OTA
    if (digitalRead(PIN_OTA) == LOW) {
      if (WiFi.status() == WL_CONNECTED) {
        performOTA(); 
      } else {
        Serial.println("Nh·∫•n OTA nh∆∞ng kh√¥ng c√≥ WiFi!");
      }
    }
}
